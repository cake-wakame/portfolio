{% extends 'poker/base.html' %}

{% block content %}
<div style="text-align: center;">
    <div class="chips-display">
        ğŸ’° æŒã¡ç‚¹: <span id="chips-amount">{{ chips }}</span>
    </div>

</div>


<div class="game-area">
    <!-- ãƒ™ãƒƒãƒˆæ®µéš -->
    <div id="betting-phase" {% if game_state != 'betting' %}style="display:none;"{% endif %}>
        <h2 style="text-align: center; margin-bottom: 20px;">ãƒ™ãƒƒãƒˆé¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
        <div style="text-align: center;">
            <form id="bet-form" onsubmit="return placeBet(event);">
                {% csrf_token %}
                <input type="number" id="bet-input" name="bet" min="1" max="{{ chips }}" value="10" required>
                <button type="submit">ãƒ™ãƒƒãƒˆ</button>
            </form>
        </div>
    </div>

    <!-- ã‚«ãƒ¼ãƒ‰äº¤æ›æ®µéš -->
    <div id="exchange-phase" {% if game_state != 'exchange' %}style="display:none;"{% endif %}>
        <h2 style="text-align: center; margin-bottom: 20px;">äº¤æ›ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæœ€å¤§5æšï¼‰</h2>
        <p style="text-align: center; margin-bottom: 20px;">ãƒ™ãƒƒãƒˆé¡: <strong>{{ bet_amount }}</strong></p>
        
        <div style="text-align: center; margin: 30px 0;">
            <h3>ã‚ãªãŸã®æ‰‹æœ­</h3>
            <div id="player-cards" style="margin: 20px 0;">
                {% for card in player_hand %}
                <div class="card {% if card.suit == 'â™¥' or card.suit == 'â™¦' %}hearts{% else %}spades{% endif %}" 
                     data-index="{{ forloop.counter0 }}"
                     onclick="toggleCardSelection(this)">
                    <div class="card-content">{{ card.rank }}</div>
                    <div class="card-suit">{{ card.suit }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div style="text-align: center;">
            <button onclick="exchangeCards()">ã‚«ãƒ¼ãƒ‰äº¤æ›</button>
            <button onclick="exchangeCards(true)" style="background: #3498db; margin-left: 10px;">äº¤æ›ã—ãªã„</button>
        </div>
    </div>

    <!-- çµæœè¡¨ç¤ºæ®µéš -->
    <div id="result-phase" {% if game_state != 'result' %}style="display:none;"{% endif %}>
        <div style="text-align: center;">
            <h2>çµæœ</h2>
            
            <div style="margin: 30px 0;">
                <h3>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ‰‹æœ­</h3>
                <div id="computer-cards" style="margin: 20px 0;">
                    <!-- JavaScript ã§è¡¨ç¤º -->
                </div>
                <div id="computer-hand-name" class="hand-name"></div>
            </div>
            
            <div style="margin: 30px 0;">
                <h3>ã‚ãªãŸã®æ‰‹æœ­</h3>
                <div id="result-player-cards" style="margin: 20px 0;">
                    <!-- JavaScript ã§è¡¨ç¤º -->
                </div>
                <div id="player-hand-name" class="hand-name"></div>
            </div>
            
            <div id="result-message" class="result-message"></div>
            
            <button onclick="newGame()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
const selectedCards = new Set();

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleCardSelection(cardElement) {
    const index = parseInt(cardElement.dataset.index);
    
    if (selectedCards.has(index)) {
        selectedCards.delete(index);
        cardElement.classList.remove('selected');
    } else {
        if (selectedCards.size < 5) {
            selectedCards.add(index);
            cardElement.classList.add('selected');
        }
    }
}

function placeBet(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    fetch("{% url 'poker:place_bet' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('betting-phase').style.display = 'none';
            document.getElementById('exchange-phase').style.display = 'block';
        } else {
            alert(data.error);
        }
    });
    
    return false;
}

function exchangeCards(skipExchange = false) {
    const cardsToExchange = skipExchange ? [] : Array.from(selectedCards);
    
    const formData = new FormData();
    formData.append('cards', JSON.stringify(cardsToExchange));
    
    fetch("{% url 'poker:exchange_cards' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(data);
        }
    });
}

function showResult(data) {
    document.getElementById('exchange-phase').style.display = 'none';
    document.getElementById('result-phase').style.display = 'block';
    
    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ‰‹æœ­è¡¨ç¤º
    const computerCardsDiv = document.getElementById('computer-cards');
    computerCardsDiv.innerHTML = '';
    data.computer_hand.forEach(card => {
        const cardDiv = document.createElement('div');
        const suitClass = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'hearts' : 'spades';
        cardDiv.className = `card ${suitClass}`;
        cardDiv.innerHTML = `
            <div class="card-content">${card.rank}</div>
            <div class="card-suit">${card.suit}</div>
        `;
        computerCardsDiv.appendChild(cardDiv);
    });
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­è¡¨ç¤º
    const playerCardsDiv = document.getElementById('result-player-cards');
    playerCardsDiv.innerHTML = '';
    data.player_hand.forEach(card => {
        const cardDiv = document.createElement('div');
        const suitClass = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'hearts' : 'spades';
        cardDiv.className = `card ${suitClass}`;
        cardDiv.innerHTML = `
            <div class="card-content">${card.rank}</div>
            <div class="card-suit">${card.suit}</div>
        `;
        playerCardsDiv.appendChild(cardDiv);
    });
    
    // å½¹åè¡¨ç¤º
    document.getElementById('computer-hand-name').textContent = `å½¹: ${data.computer_hand_name}`;
    document.getElementById('player-hand-name').textContent = `å½¹: ${data.player_hand_name}`;
    
    // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const resultDiv = document.getElementById('result-message');
    resultDiv.textContent = data.result;
    
    if (data.result.includes('å‹ã¡')) {
        resultDiv.className = 'result-message result-win';
    } else if (data.result.includes('è² ã‘')) {
        resultDiv.className = 'result-message result-lose';
    } else {
        resultDiv.className = 'result-message result-draw';
    }
    
    // ãƒãƒƒãƒ—æ•°æ›´æ–°
    document.getElementById('chips-amount').textContent = data.chips;
}

function newGame() {
    window.location.href = "{% url 'poker:index' %}?new_game=1";
}
</script>
{% endblock %}